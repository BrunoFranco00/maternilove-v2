// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTENTICAÇÃO E USUÁRIOS
// ============================================================================

model User {
  id                  String     @id @default(cuid())
  email               String     @unique
  password            String
  name                String
  avatar              String?
  bio                 String?
  role                UserRole   @default(USER)
  status              UserStatus @default(ACTIVE)
  emailVerified       Boolean    @default(false)
  onboardingCompleted Boolean    @default(false)
  onboardingRole      UserRole?
  onboardingAt        DateTime?
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt
  deletedAt           DateTime?

  // Relacionamentos
  journey            Journey?
  moments            Moment[]
  socialPosts        SocialPost[]
  socialLikes        SocialLike[]
  socialComments     SocialComment[]
  achievements       UserAchievement[]
  leaderboardEntries LeaderboardEntry[]
  communityPosts     CommunityPost[]
  communityComments  CommunityComment[]
  directMessages     DirectMessage[]
  professional       Professional?
  company            Company?
  orders             Order[]
  reviews            Review[]
  notifications      Notification[]
  followers          UserFollower[]     @relation("following")
  following          UserFollower[]     @relation("follower")
  authSessions       AuthSession[]
  emotionalCheckins  EmotionalCheckin[]
  maternalProfile     MaternalProfile?
  maternalPersonal    MaternalPersonalData?
  maternalAddress     MaternalAddress?
  maternalHealth      MaternalHealth?
  maternalLifestyle   MaternalLifestyle?
  maternalEmotional   MaternalEmotional?
  childProfile       ChildProfile?

  @@index([email])
  @@index([role])
  @@index([status])
}

enum UserRole {
  USER
  MOTHER
  PROFESSIONAL
  COMPANY
  ADMIN
  SUPER_ADMIN
  TESTER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

// ============================================================================
// AUTENTICAÇÃO E SESSÕES
// ============================================================================

model AuthSession {
  id        String    @id @default(uuid())
  userId    String
  tokenHash String    @unique
  createdAt DateTime  @default(now())
  expiresAt DateTime
  revokedAt DateTime?
  userAgent String?
  ipAddress String?
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@index([revokedAt])
}

// ============================================================================
// EMOTIONAL CHECKIN
// ============================================================================

enum MoodType {
  HAPPY
  CALM
  TIRED
  ANXIOUS
  SAD
  OVERWHELMED
}

model EmotionalCheckin {
  id        String   @id @default(cuid())
  userId    String
  mood      MoodType
  note      String?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

// ============================================================================
// SEGUIDORES
// ============================================================================

model UserFollower {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  follower  User @relation("follower", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

// ============================================================================
// JORNADA E MOMENTOS
// ============================================================================

model Journey {
  id           String      @id @default(cuid())
  userId       String      @unique
  type         JourneyType
  startDate    DateTime
  expectedDate DateTime?
  currentStage Int         @default(1)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  stages      JourneyStage[]
  moments     Moment[]
  suggestions SmartSuggestion[]

  @@index([userId])
}

enum JourneyType {
  PREGNANCY
  POSTPARTUM
  BABY_0_3M
  BABY_3_6M
  BABY_6_12M
  BABY_1_2Y
  BABY_2_3Y
  BABY_3_5Y
}

model JourneyStage {
  id          String    @id @default(cuid())
  journeyId   String
  stage       Int
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime?
  completed   Boolean   @default(false)
  createdAt   DateTime  @default(now())

  journey Journey @relation(fields: [journeyId], references: [id], onDelete: Cascade)

  @@index([journeyId])
}

model Moment {
  id          String   @id @default(cuid())
  userId      String
  journeyId   String
  title       String
  description String?
  images      String[] @default([])
  videos      String[] @default([])
  mood        String?
  weight      Float?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  journey  Journey         @relation(fields: [journeyId], references: [id], onDelete: Cascade)
  comments MomentComment[]

  @@index([userId])
  @@index([journeyId])
}

model MomentComment {
  id        String   @id @default(cuid())
  momentId  String
  text      String
  createdAt DateTime @default(now())

  moment Moment @relation(fields: [momentId], references: [id], onDelete: Cascade)

  @@index([momentId])
}

// ============================================================================
// SUGESTÕES INTELIGENTES
// ============================================================================

model SmartSuggestion {
  id          String   @id @default(cuid())
  journeyId   String
  title       String
  description String
  category    String
  priority    Int      @default(0)
  createdAt   DateTime @default(now())

  journey Journey @relation(fields: [journeyId], references: [id], onDelete: Cascade)

  @@index([journeyId])
}

// ============================================================================
// REDE SOCIAL
// ============================================================================

model SocialPost {
  id        String   @id @default(cuid())
  userId    String
  content   String
  images    String[] @default([])
  likes     Int      @default(0)
  views     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  likes_rel SocialLike[]
  comments  SocialComment[]

  @@index([userId])
  @@index([createdAt])
}

model SocialLike {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())

  post SocialPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model SocialComment {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  text      String
  createdAt DateTime @default(now())

  post SocialPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([userId])
}

// ============================================================================
// GAMIFICAÇÃO
// ============================================================================

model Achievement {
  id          String @id @default(cuid())
  name        String
  description String
  icon        String
  points      Int

  users UserAchievement[]

  @@unique([name])
}

model UserAchievement {
  id            String   @id @default(cuid())
  userId        String
  achievementId String
  unlockedAt    DateTime @default(now())

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
}

model LeaderboardEntry {
  id        String   @id @default(cuid())
  userId    String   @unique
  points    Int      @default(0)
  rank      Int
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([rank])
  @@index([points])
}

// ============================================================================
// COMUNIDADE
// ============================================================================

model CommunityCategory {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  icon        String?

  posts CommunityPost[]
}

model CommunityPost {
  id         String   @id @default(cuid())
  userId     String
  categoryId String
  title      String
  content    String
  views      Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user     User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  category CommunityCategory  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  comments CommunityComment[]

  @@index([userId])
  @@index([categoryId])
  @@index([createdAt])
}

model CommunityComment {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  text      String
  createdAt DateTime @default(now())

  post CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([userId])
}

// ============================================================================
// MENSAGENS DIRETAS
// ============================================================================

model DirectMessage {
  id        String   @id @default(cuid())
  senderId  String
  text      String
  createdAt DateTime @default(now())

  sender User @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([senderId])
}

// ============================================================================
// PROFISSIONAIS
// ============================================================================

model Professional {
  id          String   @id @default(cuid())
  userId      String   @unique
  specialties String[]
  bio         String?
  verified    Boolean  @default(false)
  rating      Float    @default(0)
  reviewCount Int      @default(0)

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  appointments Appointment[]
  reviews      Review[]

  @@index([verified])
  @@index([rating])
}

model Appointment {
  id             String   @id @default(cuid())
  professionalId String
  date           DateTime
  duration       Int
  status         String   @default("pending")
  createdAt      DateTime @default(now())

  professional Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)

  @@index([professionalId])
  @@index([date])
}

// ============================================================================
// EMPRESAS
// ============================================================================

model Company {
  id          String  @id @default(cuid())
  userId      String  @unique
  name        String
  description String?
  logo        String?
  verified    Boolean @default(false)

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  products Product[]

  @@index([verified])
}

// ============================================================================
// MARKETPLACE
// ============================================================================

model Product {
  id          String   @id @default(cuid())
  companyId   String
  name        String
  description String
  price       Float
  image       String?
  stock       Int      @default(0)
  createdAt   DateTime @default(now())

  company    Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]
  reviews    Review[]

  @@index([companyId])
}

model Order {
  id        String   @id @default(cuid())
  userId    String
  total     Float
  status    String   @default("pending")
  createdAt DateTime @default(now())

  user  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  items OrderItem[]

  @@index([userId])
  @@index([status])
}

model OrderItem {
  id        String @id @default(cuid())
  orderId   String
  productId String
  quantity  Int
  price     Float

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([productId])
}

model Review {
  id             String   @id @default(cuid())
  userId         String
  productId      String?
  professionalId String?
  rating         Int
  text           String?
  createdAt      DateTime @default(now())

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  product      Product?      @relation(fields: [productId], references: [id], onDelete: Cascade)
  professional Professional? @relation(fields: [professionalId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([productId])
}

// ============================================================================
// BLOG
// ============================================================================

model BlogPost {
  id        String   @id @default(cuid())
  title     String
  slug      String   @unique
  content   String
  excerpt   String?
  image     String?
  published Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([published])
  @@index([createdAt])
}

// ============================================================================
// ASSINATURAS
// ============================================================================

model Subscription {
  id        String   @id @default(cuid())
  name      String
  price     Float
  features  String[]
  createdAt DateTime @default(now())
}

// ============================================================================
// NOTIFICAÇÕES
// ============================================================================

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
}

// ============================================================================
// DOMÍNIO MATERNO — Perfil materno progressivo (não substitui orientação médica)
// ============================================================================

enum PregnancyStage {
  TRYING
  PREGNANT
  POSTPARTUM
  HAS_CHILD
}

enum PregnancyType {
  SINGLE
  TWINS
  MULTIPLE
  UNKNOWN
}

enum ChildSex {
  FEMALE
  MALE
  UNKNOWN
}

enum ContentFocus {
  PREGNANCY
  NEWBORN
  TODDLER_1_2
  TODDLER_3_5
  POSTPARTUM
  GENERAL
}

enum RiskFlag {
  DIABETES
  HYPERTENSION
  THYROID
  ANEMIA
  DEPRESSION
  ANXIETY
  OTHER
}

model MaternalProfile {
  id                    String         @id @default(cuid())
  userId                String         @unique
  stage                 PregnancyStage @default(HAS_CHILD)
  dueDate               DateTime?
  lastMenstrualPeriod   DateTime?
  gestationalWeek       Int?
  gestationalDay        Int?
  pregnancyType         PregnancyType?
  isHighRisk            Boolean?
  riskFlags             RiskFlag[]     @default([])
  preferredContentFocus ContentFocus[] @default([])
  locale                String?
  timeZone              String?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([stage])
  @@index([createdAt])
  @@index([updatedAt])
}

model MaternalPersonalData {
  id        String   @id @default(cuid())
  userId    String   @unique
  fullName  String?
  phone     String?
  cpf       String?
  birthDate DateTime?
  city      String?
  state     String?
  country   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model MaternalAddress {
  id          String   @id @default(cuid())
  userId      String   @unique
  postalCode  String?
  street      String?
  number      String?
  complement  String?
  neighborhood String?
  city        String?
  state       String?
  country     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model MaternalHealth {
  id               String   @id @default(cuid())
  userId           String   @unique
  conditions       String[] @default([])
  medications      String[] @default([])
  allergies        String[] @default([])
  hasPrenatalCare  Boolean?
  prenatalCareNotes String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model MaternalLifestyle {
  id           String   @id @default(cuid())
  userId       String   @unique
  sleepQuality Int?
  activityLevel Int?
  nutritionFocus String?
  supplements  String[] @default([])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model MaternalEmotional {
  id             String   @id @default(cuid())
  userId         String   @unique
  baselineMood   MoodType?
  stressLevel    Int?
  supportNetwork Int?
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ChildProfile {
  id         String    @id @default(cuid())
  userId     String    @unique
  childName  String?
  childSex   ChildSex?
  birthDate  DateTime?
  ageMonths  Int?
  notes      String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============================================================================
// ADMIN LOGS
// ============================================================================

model AdminLog {
  id        String   @id @default(cuid())
  action    String
  entity    String
  entityId  String
  changes   String?
  createdAt DateTime @default(now())

  @@index([action])
  @@index([entity])
  @@index([createdAt])
}
